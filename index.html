<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WAAJK - Ultimate Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700;900&family=Orbitron:wght@500;900&display=swap');

        :root {
            --primary: #00ff88;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            background-color: #080810;
            background-image: 
                radial-gradient(circle at 50% 50%, #1a1a2e 0%, #050505 100%);
            color: white;
            font-family: 'Exo 2', sans-serif;
            overflow: hidden;
            touch-action: none;
            user-select: none;
        }

        /* --- UI MODERNE --- */
        .glass-panel {
            background: rgba(16, 18, 27, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        .title-gradient {
            background: linear-gradient(135deg, #00ff88 0%, #00ccff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-family: 'Orbitron', sans-serif;
            filter: drop-shadow(0 0 20px rgba(0, 255, 136, 0.3));
        }

        /* --- BOUTONS --- */
        .btn-modern {
            background: linear-gradient(90deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.1) 100%);
            border: 1px solid rgba(255,255,255,0.1);
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-modern:hover {
            background: rgba(255,255,255,0.15);
            border-color: #fff;
            transform: translateY(-2px);
            box-shadow: 0 0 30px rgba(255,255,255,0.1);
        }

        .btn-play {
            background: linear-gradient(135deg, #00ff88, #00b862);
            color: black;
            font-weight: 900;
            border: none;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.4);
        }
        .btn-play:hover {
            transform: scale(1.05);
            box-shadow: 0 0 40px rgba(0, 255, 136, 0.6);
            background: linear-gradient(135deg, #33ff99, #00ff88);
        }

        /* --- SHOP / CASIER --- */
        .skin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
        }

        .skin-card {
            background: rgba(0,0,0,0.4);
            border: 2px solid rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .skin-card:hover {
            transform: translateY(-5px);
            background: rgba(255,255,255,0.05);
        }

        .skin-card.active {
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.2);
            background: linear-gradient(180deg, rgba(0,255,136,0.05) 0%, rgba(0,0,0,0) 100%);
        }

        .skin-preview {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-bottom: 10px;
            box-shadow: 0 0 15px currentColor;
        }

        /* --- ANIMATIONS --- */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .anim-float { animation: float 6s ease-in-out infinite; }

        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .shake { animation: shake 0.5s; }

        /* --- JEU --- */
        #gameCanvas {
            border-radius: 12px;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            /* border: 1px solid rgba(255,255,255,0.1); */
        }
        
        .control-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: rgba(255,255,255,0.7);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: transform 0.1s, background 0.2s;
        }
        .control-btn:active {
            transform: scale(0.9);
            background: rgba(255,255,255,0.2);
            color: white;
        }

    </style>
</head>
<body class="h-screen w-screen flex flex-col items-center justify-center overflow-hidden">

    <!-- ARRIÈRE-PLAN ANIMÉ -->
    <div class="absolute inset-0 z-0 opacity-20 pointer-events-none">
        <div class="absolute top-1/4 left-1/4 w-96 h-96 bg-blue-500 rounded-full blur-[150px] animate-pulse"></div>
        <div class="absolute bottom-1/4 right-1/4 w-96 h-96 bg-green-500 rounded-full blur-[150px] animate-pulse" style="animation-delay: 1s;"></div>
    </div>

    <!-- UI LAYER -->
    <div id="ui-layer" class="absolute inset-0 z-20 flex items-center justify-center pointer-events-none">
        
        <!-- MENU PRINCIPAL -->
        <div id="main-menu" class="glass-panel p-10 rounded-3xl text-center pointer-events-auto max-w-md w-full mx-4 flex flex-col gap-6 anim-float">
            <div>
                <h1 class="text-7xl font-black title-gradient mb-2 tracking-tighter">WAAJK</h1>
                <p class="text-gray-400 text-sm tracking-[0.3em] uppercase opacity-70">Simulation Ultime</p>
            </div>
            
            <div class="flex flex-col gap-3 mt-4">
                <button onclick="startGame()" class="btn-modern btn-play py-5 rounded-xl text-xl flex items-center justify-center gap-3">
                    <i class="fas fa-play"></i> JOUER
                </button>
                <button onclick="showSkins()" class="btn-modern py-4 rounded-xl text-lg font-bold text-gray-200 flex items-center justify-center gap-3">
                    <i class="fas fa-tshirt"></i> CASIER & SKINS
                </button>
            </div>

            <div class="mt-4 pt-6 border-t border-white/10 flex justify-between items-center px-4">
                <div class="text-left">
                    <div class="text-xs text-gray-500 uppercase font-bold">Meilleur Score</div>
                    <div class="text-2xl font-bold text-white" id="menu-highscore">0</div>
                </div>
                <div class="text-right">
                    <div class="text-xs text-gray-500 uppercase font-bold">Skin Actuel</div>
                    <div class="text-sm font-bold text-green-400" id="current-skin-name">Neon Green</div>
                </div>
            </div>
        </div>

        <!-- BOUTIQUE / SKINS -->
        <div id="skin-menu" class="glass-panel p-8 rounded-3xl text-center pointer-events-auto max-w-lg w-full mx-4 hidden flex flex-col h-[80vh] md:h-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold font-cyber text-white">CASIER</h2>
                <span class="bg-green-500/20 text-green-400 px-3 py-1 rounded-full text-xs font-bold border border-green-500/30">TOUT EST GRATUIT</span>
            </div>
            
            <div class="overflow-y-auto flex-1 mb-6 pr-2">
                <div class="skin-grid" id="skin-grid">
                    <!-- Généré par JS -->
                </div>
            </div>

            <button onclick="showMainMenu()" class="btn-modern py-4 rounded-xl font-bold text-white w-full">
                <i class="fas fa-check mr-2"></i> VALIDER
            </button>
        </div>

        <!-- GAME OVER -->
        <div id="game-over" class="glass-panel p-10 rounded-3xl text-center pointer-events-auto max-w-sm w-full mx-4 hidden transform scale-95 opacity-0 transition-all duration-300">
            <div class="w-20 h-20 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-6 border border-red-500/20">
                <i class="fas fa-skull text-4xl text-red-500"></i>
            </div>
            <h2 class="text-4xl font-black text-white mb-2">DOMMAGE</h2>
            <p class="text-gray-400 text-sm mb-8">Tu as percuté un obstacle.</p>
            
            <div class="grid grid-cols-2 gap-4 mb-8">
                <div class="bg-white/5 p-4 rounded-xl border border-white/5">
                    <div class="text-xs text-gray-500">SCORE</div>
                    <div class="text-3xl font-bold text-white" id="final-score">0</div>
                </div>
                <div class="bg-yellow-500/10 p-4 rounded-xl border border-yellow-500/20">
                    <div class="text-xs text-yellow-600">RECORD</div>
                    <div class="text-3xl font-bold text-yellow-500" id="go-highscore">0</div>
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="showMainMenu()" class="btn-modern py-4 px-6 rounded-xl text-gray-300 flex-1">
                    <i class="fas fa-home"></i>
                </button>
                <button onclick="startGame()" class="btn-modern btn-play py-4 rounded-xl flex-1 text-lg">
                    REJOUER
                </button>
            </div>
        </div>
    </div>

    <!-- HUD EN JEU -->
    <div id="hud" class="absolute top-0 left-0 w-full p-6 flex justify-between items-start z-10 hidden pointer-events-none">
        <div class="flex flex-col">
            <div class="font-black text-2xl tracking-tighter text-white opacity-50">WAAJK</div>
        </div>
        <div class="flex gap-4">
            <div class="glass-panel px-6 py-3 rounded-2xl flex flex-col items-center">
                <span class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Score</span>
                <span id="game-score" class="font-bold text-2xl text-white">0</span>
            </div>
        </div>
    </div>

    <!-- CANEVAS -->
    <canvas id="gameCanvas" class="z-10 bg-[#0a0b14]"></canvas>

    <!-- CONTRÔLES MOBILE -->
    <div id="mobile-controls" class="absolute bottom-10 z-30 w-full flex justify-center gap-6 hidden md:hidden pointer-events-auto select-none">
        <div class="grid grid-cols-3 gap-3">
            <div></div>
            <div class="control-btn" ontouchstart="handleTouchInput('up', event)"><i class="fas fa-chevron-up"></i></div>
            <div></div>
            <div class="control-btn" ontouchstart="handleTouchInput('left', event)"><i class="fas fa-chevron-left"></i></div>
            <div class="control-btn" ontouchstart="handleTouchInput('down', event)"><i class="fas fa-chevron-down"></i></div>
            <div class="control-btn" ontouchstart="handleTouchInput('right', event)"><i class="fas fa-chevron-right"></i></div>
        </div>
    </div>

    <script>
        /**
         * WAAJK - ULTIMATE EDITION
         * Code optimisé pour haute performance et visuels modernes.
         */

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // --- CONFIGURATION ---
        let GRID_SIZE = 25; // Plus gros pour être plus "beau"
        let TILE_COUNT_X = 20;
        let TILE_COUNT_Y = 20;
        const GAME_SPEED = 14; // Un peu plus rapide et fluide

        // --- SYSTÈME DE SKINS COMPLET ---
        const SKINS = [
            { id: 'neon', name: 'NÉON VERT', color: '#00ff88', gradient: ['#00ff88', '#00cc6a'], glow: '#00ff88', eyes: 'black' },
            { id: 'cyber', name: 'CYBER PUNK', color: '#00eeff', gradient: ['#00eeff', '#d100ff'], glow: '#00eeff', eyes: 'white' },
            { id: 'magma', name: 'LAVE EN FUSION', color: '#ff3300', gradient: ['#ffaa00', '#ff0000'], glow: '#ff3300', eyes: 'yellow' },
            { id: 'ghost', name: 'SPECTRE', color: '#ffffff', gradient: ['#ffffff', '#aaaaaa'], glow: '#ffffff', eyes: 'red' },
            { id: 'gold', name: 'MIDAS OR', color: '#ffd700', gradient: ['#fff7cc', '#daa520'], glow: '#ffd700', eyes: 'black' },
            { id: 'void', name: 'NÉANT VIOLET', color: '#9d00ff', gradient: ['#cd00ff', '#4b0082'], glow: '#9d00ff', eyes: 'white' },
            { id: 'toxic', name: 'TOXIQUE', color: '#ccff00', gradient: ['#ccff00', '#66aa00'], glow: '#ccff00', eyes: 'black' },
            { id: 'ice', name: 'GLACE ÉTERNELLE', color: '#aaddff', gradient: ['#ffffff', '#0099ff'], glow: '#00ccff', eyes: 'blue' }
        ];

        let currentSkin = SKINS[0];
        let gameState = 'MENU';
        let score = 0;
        let highScore = parseInt(localStorage.getItem('waajk_highscore')) || 0;
        
        let snake = [];
        let velocity = { x: 0, y: 0 };
        let nextVelocity = { x: 0, y: 0 }; // Buffer pour éviter bug demi-tour rapide
        let food = { x: 5, y: 5 };
        let particles = [];
        let shakeIntensity = 0;

        // --- GESTION DE LA TAILLE ET CANVAS ---
        function resizeCanvas() {
            // Calculer pour prendre le max de place avec un margin
            const margin = window.innerWidth < 768 ? 20 : 60;
            const uiHeight = window.innerWidth < 768 ? 250 : 100; // Espace pour controles mobile

            const maxWidth = window.innerWidth - margin;
            const maxHeight = window.innerHeight - margin - (window.innerWidth < 768 ? 100 : 0);

            // Calcul du nombre de tuiles possibles
            const cols = Math.floor(maxWidth / GRID_SIZE);
            const rows = Math.floor(maxHeight / GRID_SIZE);

            TILE_COUNT_X = cols;
            TILE_COUNT_Y = rows;

            canvas.width = TILE_COUNT_X * GRID_SIZE;
            canvas.height = TILE_COUNT_Y * GRID_SIZE;
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        updateUI();
        initSkinShop();

        // --- GAME LOOP ---
        function startGame() {
            snake = [
                { x: Math.floor(TILE_COUNT_X / 2), y: Math.floor(TILE_COUNT_Y / 2) },
                { x: Math.floor(TILE_COUNT_X / 2), y: Math.floor(TILE_COUNT_Y / 2) + 1 },
                { x: Math.floor(TILE_COUNT_X / 2), y: Math.floor(TILE_COUNT_Y / 2) + 2 }
            ];
            velocity = { x: 0, y: -1 };
            nextVelocity = { x: 0, y: -1 };
            score = 0;
            particles = [];
            shakeIntensity = 0;
            placeFood();
            
            gameState = 'PLAYING';
            
            // Transitions UI
            document.getElementById('ui-layer').classList.add('pointer-events-none');
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('game-over').classList.add('hidden');
            document.getElementById('game-over').classList.remove('scale-100', 'opacity-100');
            document.getElementById('game-over').classList.add('scale-95', 'opacity-0');
            document.getElementById('skin-menu').classList.add('hidden');
            document.getElementById('hud').classList.remove('hidden');
            
            updateScoreDisplay();

            if(window.matchMedia("(max-width: 768px)").matches) {
                document.getElementById('mobile-controls').classList.remove('hidden');
            }

            loop();
        }

        let lastTime = 0;
        let accumulator = 0;
        const step = 1 / GAME_SPEED;

        function loop(time = 0) {
            if (gameState !== 'PLAYING') return;
            requestAnimationFrame(loop);

            const deltaTime = (time - lastTime) / 1000;
            lastTime = time;
            accumulator += deltaTime;

            while (accumulator > step) {
                update();
                accumulator -= step;
            }

            draw();
        }

        // --- LOGIQUE ---
        function update() {
            velocity = nextVelocity; // Appliquer la direction bufférisée

            const head = { x: snake[0].x + velocity.x, y: snake[0].y + velocity.y };

            // Collision Murs (Mortelle)
            if (head.x < 0 || head.x >= TILE_COUNT_X || head.y < 0 || head.y >= TILE_COUNT_Y) {
                triggerGameOver();
                return;
            }

            // Collision Soi-même
            for (let part of snake) {
                if (head.x === part.x && head.y === part.y) {
                    triggerGameOver();
                    return;
                }
            }

            snake.unshift(head);

            // Manger
            if (head.x === food.x && head.y === food.y) {
                score += 10;
                updateScoreDisplay();
                placeFood();
                spawnEatParticles(head.x, head.y, currentSkin.glow);
            } else {
                snake.pop();
            }

            // Physique des particules
            updateParticles();
            
            // Réduction shake
            if (shakeIntensity > 0) shakeIntensity *= 0.9;
            if (shakeIntensity < 0.5) shakeIntensity = 0;
        }

        // --- RENDU GRAPHIQUE ---
        function draw() {
            // Effacer et appliquer background
            ctx.fillStyle = '#0a0b14'; // Fond noir légèrement teinté
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Effet Screen Shake
            ctx.save();
            if (shakeIntensity > 0) {
                const dx = (Math.random() - 0.5) * shakeIntensity;
                const dy = (Math.random() - 0.5) * shakeIntensity;
                ctx.translate(dx, dy);
            }

            // Dessiner la grille (Points subtils)
            ctx.fillStyle = 'rgba(255, 255, 255, 0.03)';
            for (let x = 0; x < TILE_COUNT_X; x++) {
                for (let y = 0; y < TILE_COUNT_Y; y++) {
                    ctx.beginPath();
                    ctx.arc(x * GRID_SIZE + GRID_SIZE/2, y * GRID_SIZE + GRID_SIZE/2, 1, 0, Math.PI*2);
                    ctx.fill();
                }
            }

            // Dessiner la Pomme
            drawFood();

            // Dessiner le Serpent
            drawSnake();

            // Dessiner Particules
            drawParticles();

            ctx.restore();
        }

        function drawSnake() {
            snake.forEach((part, index) => {
                const x = part.x * GRID_SIZE;
                const y = part.y * GRID_SIZE;
                const size = GRID_SIZE - 2;
                
                // Dégradé pour le corps
                const gradient = ctx.createLinearGradient(x, y, x + size, y + size);
                gradient.addColorStop(0, currentSkin.gradient[0]);
                gradient.addColorStop(1, currentSkin.gradient[1]);

                ctx.fillStyle = gradient;
                
                // Glow uniquement sur la tête et un peu sur le corps
                if (index === 0) {
                    ctx.shadowBlur = 20;
                    ctx.shadowColor = currentSkin.glow;
                } else {
                    ctx.shadowBlur = 0;
                }

                // Dessin avec coins arrondis
                // Tête plus grosse, queue plus fine
                let scale = 1;
                if (index > 0) scale = 1 - (index / (snake.length + 5)) * 0.4;
                
                const drawSize = size * scale;
                const offset = (GRID_SIZE - drawSize) / 2;

                roundRect(ctx, x + offset, y + offset, drawSize, drawSize, index === 0 ? 8 : 5);
                ctx.fill();

                // Yeux sur la tête
                if (index === 0) {
                    ctx.shadowBlur = 0;
                    ctx.fillStyle = currentSkin.eyes;
                    
                    // Calcul position yeux selon direction
                    let eyeX1, eyeY1, eyeX2, eyeY2;
                    const eyeSize = drawSize * 0.2;
                    const base = x + offset;
                    const baseV = y + offset;
                    
                    if (velocity.y === -1) { // Haut
                        eyeX1 = base + drawSize*0.2; eyeY1 = baseV + drawSize*0.2;
                        eyeX2 = base + drawSize*0.6; eyeY2 = baseV + drawSize*0.2;
                    } else if (velocity.y === 1) { // Bas
                        eyeX1 = base + drawSize*0.2; eyeY1 = baseV + drawSize*0.6;
                        eyeX2 = base + drawSize*0.6; eyeY2 = baseV + drawSize*0.6;
                    } else if (velocity.x === -1) { // Gauche
                        eyeX1 = base + drawSize*0.2; eyeY1 = baseV + drawSize*0.2;
                        eyeX2 = base + drawSize*0.2; eyeY2 = baseV + drawSize*0.6;
                    } else { // Droite
                        eyeX1 = base + drawSize*0.6; eyeY1 = baseV + drawSize*0.2;
                        eyeX2 = base + drawSize*0.6; eyeY2 = baseV + drawSize*0.6;
                    }

                    ctx.beginPath(); ctx.arc(eyeX1 + eyeSize/2, eyeY1 + eyeSize/2, eyeSize/2, 0, Math.PI*2); ctx.fill();
                    ctx.beginPath(); ctx.arc(eyeX2 + eyeSize/2, eyeY2 + eyeSize/2, eyeSize/2, 0, Math.PI*2); ctx.fill();
                }
            });
            ctx.shadowBlur = 0; // Reset
        }

        function drawFood() {
            const x = food.x * GRID_SIZE + GRID_SIZE/2;
            const y = food.y * GRID_SIZE + GRID_SIZE/2;
            
            // Animation de pulsation
            const pulse = Math.sin(Date.now() / 150) * 3;
            
            ctx.shadowBlur = 15;
            ctx.shadowColor = currentSkin.glow; // La nourriture a la couleur du skin pour matcher le thème
            ctx.fillStyle = '#fff';
            
            ctx.beginPath();
            ctx.arc(x, y, (GRID_SIZE/2 - 4) + pulse/2, 0, Math.PI * 2);
            ctx.fill();

            // Halo externe
            ctx.strokeStyle = currentSkin.color;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(x, y, (GRID_SIZE/2) + pulse, 0, Math.PI * 2);
            ctx.stroke();

            ctx.shadowBlur = 0;
        }

        function roundRect(ctx, x, y, width, height, radius) {
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
            ctx.lineTo(x + width, y + height - radius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            ctx.lineTo(x + radius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath();
        }

        // --- PARTICULES ---
        function spawnEatParticles(gx, gy, color) {
            const cx = gx * GRID_SIZE + GRID_SIZE/2;
            const cy = gy * GRID_SIZE + GRID_SIZE/2;
            
            for(let i=0; i<12; i++) {
                particles.push({
                    x: cx,
                    y: cy,
                    vx: (Math.random() - 0.5) * 8,
                    vy: (Math.random() - 0.5) * 8,
                    life: 1.0,
                    color: color,
                    size: Math.random() * 3 + 1
                });
            }
        }

        function updateParticles() {
            for(let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.life -= 0.04;
                p.size *= 0.95; // Shrink
                
                if(p.life <= 0) particles.splice(i, 1);
            }
        }

        function drawParticles() {
            particles.forEach(p => {
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
                ctx.fill();
            });
            ctx.globalAlpha = 1.0;
        }

        // --- LOGIQUE JEU ---
        function placeFood() {
            let valid = false;
            while (!valid) {
                food.x = Math.floor(Math.random() * TILE_COUNT_X);
                food.y = Math.floor(Math.random() * TILE_COUNT_Y);
                valid = !snake.some(part => part.x === food.x && part.y === food.y);
            }
        }

        function triggerGameOver() {
            gameState = 'GAMEOVER';
            shakeIntensity = 20; // Gros shake
            
            // Effet flash rouge
            const flash = document.createElement('div');
            flash.className = 'absolute inset-0 bg-red-500 z-50 pointer-events-none transition-opacity duration-500';
            document.body.appendChild(flash);
            setTimeout(() => flash.style.opacity = '0', 50);
            setTimeout(() => flash.remove(), 500);

            if (score > highScore) {
                highScore = score;
                localStorage.setItem('waajk_highscore', highScore);
            }

            updateUI();
            
            document.getElementById('hud').classList.add('hidden');
            document.getElementById('mobile-controls').classList.add('hidden');
            document.getElementById('ui-layer').classList.remove('pointer-events-none');
            
            const goPanel = document.getElementById('game-over');
            goPanel.classList.remove('hidden');
            // Petit délai pour l'animation d'apparition
            setTimeout(() => {
                goPanel.classList.remove('scale-95', 'opacity-0');
                goPanel.classList.add('scale-100', 'opacity-100');
            }, 50);

            document.getElementById('final-score').innerText = score;
        }

        // --- INTERFACE (UI) ---
        function showMainMenu() {
            gameState = 'MENU';
            document.getElementById('skin-menu').classList.add('hidden');
            document.getElementById('game-over').classList.add('hidden');
            document.getElementById('main-menu').classList.remove('hidden');
            updateUI();
        }

        function showSkins() {
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('skin-menu').classList.remove('hidden');
        }

        function updateUI() {
            document.getElementById('menu-highscore').innerText = highScore;
            document.getElementById('go-highscore').innerText = highScore;
            document.getElementById('current-skin-name').innerText = currentSkin.name;
        }

        function updateScoreDisplay() {
            const scoreEl = document.getElementById('game-score');
            scoreEl.innerText = score;
            // Petit effet de "pop" sur le score
            scoreEl.style.transform = "scale(1.5)";
            scoreEl.style.color = currentSkin.color;
            setTimeout(() => {
                scoreEl.style.transform = "scale(1)";
                scoreEl.style.color = "white";
            }, 100);
        }

        // --- BOUTIQUE DE SKINS ---
        function initSkinShop() {
            const grid = document.getElementById('skin-grid');
            grid.innerHTML = '';

            SKINS.forEach(skin => {
                const card = document.createElement('div');
                card.className = `skin-card ${skin.id === currentSkin.id ? 'active' : ''}`;
                card.onclick = () => {
                    currentSkin = skin;
                    initSkinShop(); // Re-render pour update la classe active
                    // Petit effet son (simulé par vibration)
                    if(navigator.vibrate) navigator.vibrate(5);
                };

                // Preview Circle
                const preview = document.createElement('div');
                preview.className = 'skin-preview';
                preview.style.background = `linear-gradient(135deg, ${skin.gradient[0]}, ${skin.gradient[1]})`;
                preview.style.color = skin.glow; // Pour le box-shadow

                const name = document.createElement('span');
                name.className = 'text-[10px] font-bold text-gray-300 uppercase tracking-wider text-center';
                name.innerText = skin.name;

                if (skin.id === currentSkin.id) {
                    const check = document.createElement('div');
                    check.innerHTML = '<i class="fas fa-check-circle text-green-400 absolute top-2 right-2 text-xs"></i>';
                    card.appendChild(check);
                }

                card.appendChild(preview);
                card.appendChild(name);
                grid.appendChild(card);
            });
        }

        // --- INPUTS ---
        window.addEventListener('keydown', e => {
            if (gameState !== 'PLAYING') return;
            
            switch(e.key) {
                case 'ArrowUp': if (velocity.y !== 1) nextVelocity = {x: 0, y: -1}; break;
                case 'ArrowDown': if (velocity.y !== -1) nextVelocity = {x: 0, y: 1}; break;
                case 'ArrowLeft': if (velocity.x !== 1) nextVelocity = {x: -1, y: 0}; break;
                case 'ArrowRight': if (velocity.x !== -1) nextVelocity = {x: 1, y: 0}; break;
            }
        });

        function handleTouchInput(dir, e) {
            if(e) e.preventDefault();
            if (gameState !== 'PLAYING') return;
            if(navigator.vibrate) navigator.vibrate(10);

            switch(dir) {
                case 'up': if (velocity.y !== 1) nextVelocity = {x: 0, y: -1}; break;
                case 'down': if (velocity.y !== -1) nextVelocity = {x: 0, y: 1}; break;
                case 'left': if (velocity.x !== 1) nextVelocity = {x: -1, y: 0}; break;
                case 'right': if (velocity.x !== -1) nextVelocity = {x: 1, y: 0}; break;
            }
        }
    </script>
</body>
</html>
