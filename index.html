<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WAAJK - GOD MODE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700;900&family=Orbitron:wght@500;900&display=swap');

        :root {
            --primary: #00ff88;
            --glass: rgba(16, 18, 27, 0.9);
            --glass-border: rgba(255, 255, 255, 0.08);
        }

        body {
            background-color: #050508;
            background-image: radial-gradient(circle at 50% 50%, #11111a 0%, #000000 100%);
            color: white;
            font-family: 'Exo 2', sans-serif;
            overflow: hidden;
            touch-action: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- CRT EFFECT (NOUVEAU) --- */
        .crt-overlay {
            background: linear-gradient(
                rgba(18, 16, 16, 0) 50%, 
                rgba(0, 0, 0, 0.1) 50%
            ), linear-gradient(
                90deg, 
                rgba(255, 0, 0, 0.03), 
                rgba(0, 255, 0, 0.01), 
                rgba(0, 0, 255, 0.03)
            );
            background-size: 100% 3px, 3px 100%;
            box-shadow: inset 0 0 80px rgba(0,0,0,0.6);
            pointer-events: none;
            position: absolute;
            inset: 0;
            z-index: 50;
            opacity: 0.8;
        }

        /* --- UI MODERNE --- */
        .glass-panel {
            background: var(--glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 20px 50px rgba(0,0,0,0.6), inset 0 0 20px rgba(255,255,255,0.02);
        }

        .title-gradient {
            background: linear-gradient(135deg, #00ff88 0%, #00ccff 50%, #00ff88 100%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-family: 'Orbitron', sans-serif;
            animation: gradientMove 3s linear infinite;
            filter: drop-shadow(0 0 15px rgba(0, 255, 136, 0.4));
        }

        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }

        /* --- BOUTONS --- */
        .btn-modern {
            background: linear-gradient(180deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.02) 100%);
            border: 1px solid rgba(255,255,255,0.1);
            position: relative;
            overflow: hidden;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-modern:hover {
            background: rgba(255,255,255,0.12);
            border-color: rgba(255,255,255,0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        .btn-modern:active {
            transform: translateY(0);
        }

        .btn-play {
            background: linear-gradient(135deg, #00ff88, #00b862);
            color: #002211;
            font-weight: 900;
            border: none;
            box-shadow: 0 0 25px rgba(0, 255, 136, 0.3);
            text-shadow: 0 1px 0 rgba(255,255,255,0.3);
        }
        
        .btn-play:hover {
            box-shadow: 0 0 40px rgba(0, 255, 136, 0.5);
            transform: scale(1.02) translateY(-2px);
        }

        /* --- SHOP / CASIER --- */
        .skin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 12px;
        }

        .skin-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .skin-card:hover {
            background: rgba(255,255,255,0.08);
            transform: translateY(-3px);
        }

        .skin-card.active {
            border-color: var(--primary);
            background: linear-gradient(180deg, rgba(0,255,136,0.1) 0%, rgba(0,0,0,0) 100%);
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.15);
        }

        .skin-preview {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            margin-bottom: 8px;
            box-shadow: 0 0 10px currentColor;
        }

        /* --- HUD & ANIMATIONS --- */
        #combo-text {
            font-family: 'Orbitron', sans-serif;
            font-weight: 900;
            font-style: italic;
            transition: transform 0.1s;
        }

        .combo-pop {
            animation: comboPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes comboPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.5) rotate(-5deg); color: #fff; }
            100% { transform: scale(1) rotate(0); }
        }

        .score-float {
            position: absolute;
            font-weight: bold;
            font-size: 20px;
            pointer-events: none;
            animation: floatUp 1s forwards;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            z-index: 50;
        }

        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-50px) scale(1.2); opacity: 0; }
        }

        .countdown-text {
            font-family: 'Orbitron', sans-serif;
            font-size: 8rem;
            font-weight: 900;
            background: linear-gradient(to bottom, #fff, #888);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5));
            animation: zoomIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes zoomIn {
            from { transform: scale(0); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* --- JEU --- */
        #gameCanvas {
            border-radius: 4px;
            box-shadow: 0 0 80px rgba(0,0,0,0.9);
            outline: 1px solid rgba(255,255,255,0.05);
            transition: transform 0.1s;
        }
        
        /* Chromatic Aberration Effect on Hit */
        .glitch-effect {
            animation: glitch-anim 0.2s infinite;
        }
        
        @keyframes glitch-anim {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }

        .mobile-hint {
            animation: fadeHint 3s infinite;
        }
        @keyframes fadeHint {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col items-center justify-center overflow-hidden">

    <!-- CRT SCANLINE OVERLAY -->
    <div class="crt-overlay"></div>

    <!-- UI LAYER -->
    <div id="ui-layer" class="absolute inset-0 z-40 flex items-center justify-center pointer-events-none">
        
        <!-- MENU PRINCIPAL -->
        <div id="main-menu" class="glass-panel p-10 rounded-3xl text-center pointer-events-auto max-w-md w-full mx-4 flex flex-col gap-8 transform transition-all hover:scale-[1.01]">
            <div class="relative">
                <div class="absolute -top-10 left-1/2 transform -translate-x-1/2 w-32 h-32 bg-green-500 rounded-full blur-[80px] opacity-20"></div>
                <h1 class="text-7xl font-black title-gradient mb-1 tracking-tighter relative z-10">WAAJK</h1>
                <div class="flex justify-center gap-2 text-[10px] tracking-[0.4em] text-gray-400 font-bold uppercase opacity-60">
                    <span>Speed</span> &bull; <span>Style</span> &bull; <span>Skill</span>
                </div>
            </div>
            
            <div class="flex flex-col gap-3 mt-2">
                <button onclick="safeStartGame()" class="btn-modern btn-play py-5 rounded-xl text-xl flex items-center justify-center gap-3 group">
                    <i class="fas fa-play text-sm group-hover:scale-110 transition-transform"></i> 
                    <span>JOUER</span>
                </button>
                <button onclick="SoundManager.safeInit(); showSkins()" class="btn-modern py-4 rounded-xl text-lg font-bold text-gray-300 flex items-center justify-center gap-3 hover:text-white">
                    <i class="fas fa-layer-group text-sm"></i> 
                    <span>PERSONNALISER</span>
                </button>
            </div>

            <div class="mt-2 pt-6 border-t border-white/5 flex justify-between items-center px-2">
                <div class="text-left">
                    <div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">Record</div>
                    <div class="text-2xl font-bold text-white font-[Orbitron]" id="menu-highscore">0</div>
                </div>
                <div class="text-right flex flex-col items-end">
                    <div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">Style</div>
                    <div class="text-sm font-bold text-green-400 flex items-center gap-2">
                        <span id="current-skin-name">Neon Green</span>
                        <div id="menu-skin-dot" class="w-2 h-2 rounded-full bg-green-400 shadow-[0_0_10px_currentColor]"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- BOUTIQUE / SKINS -->
        <div id="skin-menu" class="glass-panel p-6 rounded-3xl text-center pointer-events-auto max-w-lg w-full mx-4 hidden flex flex-col h-[80vh] md:h-auto border-t border-white/10">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold font-[Orbitron] text-white flex items-center gap-2">
                    <i class="fas fa-warehouse text-gray-500 text-lg"></i> ARMURERIE
                </h2>
                <span class="bg-green-500/10 text-green-400 px-3 py-1 rounded-full text-[10px] font-bold border border-green-500/20 tracking-wider">UNLOCKED</span>
            </div>
            
            <div class="overflow-y-auto flex-1 mb-6 pr-1 custom-scrollbar">
                <div class="skin-grid" id="skin-grid">
                    <!-- Généré par JS -->
                </div>
            </div>

            <button onclick="SoundManager.play('click'); showMainMenu()" class="btn-modern py-4 rounded-xl font-bold text-white w-full border-green-500/30 hover:bg-green-500/10 hover:border-green-500/50">
                VALIDER L'ÉQUIPEMENT
            </button>
        </div>

        <!-- GAME OVER -->
        <div id="game-over" class="glass-panel p-10 rounded-3xl text-center pointer-events-auto max-w-sm w-full mx-4 hidden transform scale-95 opacity-0 transition-all duration-300">
            <div class="absolute inset-0 bg-red-500/5 rounded-3xl animate-pulse"></div>
            <div class="relative z-10">
                <div class="w-20 h-20 bg-gradient-to-br from-red-500/20 to-orange-500/20 rounded-2xl flex items-center justify-center mx-auto mb-6 border border-white/10 shadow-lg backdrop-blur-md">
                    <i class="fas fa-skull text-4xl text-red-400 drop-shadow-[0_0_15px_rgba(248,113,113,0.5)]"></i>
                </div>
                <h2 class="text-4xl font-black text-white mb-2 font-[Orbitron] tracking-tight">ÉCHEC</h2>
                <p class="text-gray-400 text-xs mb-8 uppercase tracking-widest font-bold">Système compromis</p>
                
                <div class="grid grid-cols-2 gap-4 mb-8">
                    <div class="bg-black/40 p-4 rounded-xl border border-white/5">
                        <div class="text-[10px] text-gray-500 font-bold uppercase">Score</div>
                        <div class="text-3xl font-bold text-white" id="final-score">0</div>
                    </div>
                    <div class="bg-yellow-500/5 p-4 rounded-xl border border-yellow-500/20">
                        <div class="text-[10px] text-yellow-600 font-bold uppercase">Record</div>
                        <div class="text-3xl font-bold text-yellow-500" id="go-highscore">0</div>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button onclick="SoundManager.play('click'); showMainMenu()" class="btn-modern py-4 px-6 rounded-xl text-gray-400 hover:text-white flex-none border-white/5 bg-black/20">
                        <i class="fas fa-home"></i>
                    </button>
                    <button onclick="safeStartGame()" class="btn-modern btn-play py-4 rounded-xl flex-1 text-lg flex items-center justify-center gap-2">
                        <i class="fas fa-redo-alt text-sm"></i> REJOUER
                    </button>
                </div>
            </div>
        </div>

        <!-- PAUSE MENU -->
        <div id="pause-menu" class="glass-panel p-8 rounded-2xl text-center pointer-events-auto max-w-xs w-full hidden">
            <h2 class="text-3xl font-bold font-[Orbitron] text-white mb-6">PAUSE</h2>
            <div class="space-y-3">
                <button onclick="resumeGame()" class="btn-modern w-full py-4 rounded-xl font-bold text-green-400 border-green-500/30">REPRENDRE</button>
                <button onclick="quitToMenu()" class="btn-modern w-full py-4 rounded-xl font-bold text-red-400 border-red-500/30">ABANDONNER</button>
            </div>
        </div>

        <!-- COUNTDOWN -->
        <div id="countdown" class="hidden pointer-events-none">
            <div id="countdown-val" class="countdown-text">3</div>
        </div>
    </div>

    <!-- HUD EN JEU -->
    <div id="hud" class="absolute inset-0 pointer-events-none hidden flex flex-col justify-between p-6 z-30">
        <div class="flex justify-between items-start">
            <div class="flex flex-col">
                <div class="font-black text-xl tracking-tighter text-white/30 font-[Orbitron]">WAAJK</div>
                <div id="combo-container" class="opacity-0 transition-opacity duration-300">
                    <div class="text-xs text-yellow-500 font-bold uppercase tracking-widest mt-1">Combo</div>
                    <div id="combo-text" class="text-4xl text-yellow-400 drop-shadow-[0_0_10px_rgba(250,204,21,0.5)]">x1</div>
                </div>
            </div>

            <div class="flex gap-3 items-center">
                 <button onclick="togglePause()" class="pointer-events-auto bg-white/5 hover:bg-white/10 w-10 h-10 rounded-full flex items-center justify-center border border-white/10 backdrop-blur-md transition-colors">
                    <i class="fas fa-pause text-xs text-white"></i>
                </button>
                <div class="glass-panel px-5 py-2 rounded-full flex flex-col items-center min-w-[80px]">
                    <span class="text-[9px] text-gray-400 font-bold uppercase tracking-wider">Score</span>
                    <span id="game-score" class="font-bold text-2xl text-white font-[Orbitron]">0</span>
                </div>
            </div>
        </div>

        <!-- Hint pour mobile -->
        <div id="mobile-hint" class="text-center text-white/20 text-sm font-bold uppercase tracking-[0.2em] mobile-hint md:hidden">
            Swipe pour diriger
        </div>
    </div>

    <!-- CANEVAS -->
    <canvas id="gameCanvas" class="z-10 bg-[#0a0b14] cursor-crosshair"></canvas>

    <script>
        /**
         * WAAJK - GOD MODE EDITION (PATCHED & IMPROVED)
         * Audio Synthwave, Combo System, Swipe Controls, Particles V2, CRT, Dynamic Speed
         */

        // --- AUDIO ENGINE (Robust & Generative) ---
        const SoundManager = {
            ctx: null,
            bgOscillators: [],
            isMuted: false,

            safeInit: function() {
                try {
                    if (!this.ctx) {
                        const AudioContext = window.AudioContext || window.webkitAudioContext;
                        this.ctx = new AudioContext();
                    }
                    if (this.ctx.state === 'suspended') {
                        this.ctx.resume();
                    }
                } catch(e) {
                    console.warn("Audio init failed:", e);
                }
            },

            play: function(type) {
                if (!this.ctx) return;
                
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain);
                gain.connect(this.ctx.destination);

                const now = this.ctx.currentTime;

                if (type === 'eat') {
                    // Futuristic Blip
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(800 + (combo*50), now);
                    osc.frequency.exponentialRampToValueAtTime(1600 + (combo*50), now + 0.1);
                    gain.gain.setValueAtTime(0.2, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    osc.start(now);
                    osc.stop(now + 0.1);
                } 
                else if (type === 'combo') {
                    // Power Up Chord
                    osc.type = 'triangle';
                    // Arpeggio effect
                    osc.frequency.setValueAtTime(440, now);
                    osc.frequency.setValueAtTime(554, now + 0.05); // C#
                    osc.frequency.setValueAtTime(659, now + 0.10); // E
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.3);
                    osc.start(now);
                    osc.stop(now + 0.3);
                }
                else if (type === 'click') {
                    // UI Click
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(600, now);
                    gain.gain.setValueAtTime(0.05, now);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
                    osc.start(now);
                    osc.stop(now + 0.05);
                }
                else if (type === 'die') {
                    // Crash / Glitch
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(150, now);
                    osc.frequency.exponentialRampToValueAtTime(40, now + 0.5);
                    gain.gain.setValueAtTime(0.3, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                    osc.start(now);
                    osc.stop(now + 0.5);
                }
            },
            
            // Simple generative background beat (Optional)
            startMusic: function() {
               // Pourrait être ajouté ici mais gardons le simple pour éviter les lags audio
            }
        };

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // --- CONFIGURATION ---
        let GRID_SIZE = 25; 
        let TILE_COUNT_X = 20;
        let TILE_COUNT_Y = 20;
        const BASE_SPEED = 12; // Un peu plus lent au début pour permettre l'accélération
        let gameSpeed = BASE_SPEED;

        // --- SKINS ---
        const SKINS = [
            { id: 'neon', name: 'NÉON VERT', color: '#00ff88', gradient: ['#00ff88', '#00cc6a'], glow: '#00ff88', eyes: '#000' },
            { id: 'cyber', name: 'CYBER PUNK', color: '#00eeff', gradient: ['#00eeff', '#d100ff'], glow: '#00eeff', eyes: '#fff' },
            { id: 'magma', name: 'MAGMA', color: '#ff4400', gradient: ['#ff8800', '#ff0000'], glow: '#ff4400', eyes: '#ffea00' },
            { id: 'void', name: 'NÉANT', color: '#a020f0', gradient: ['#d050ff', '#4b0082'], glow: '#a020f0', eyes: '#fff' },
            { id: 'gold', name: 'MIDAS', color: '#ffd700', gradient: ['#fff7cc', '#c59200'], glow: '#ffd700', eyes: '#000' },
            { id: 'matrix', name: 'MATRIX', color: '#0f0', gradient: ['#0f0', '#050'], glow: '#0f0', eyes: '#000' },
            { id: 'ice', name: 'ZÉRO ABSOLU', color: '#aaddff', gradient: ['#ffffff', '#0099ff'], glow: '#00ccff', eyes: '#003366' },
            { id: 'blood', name: 'VAMPIRE', color: '#ff0033', gradient: ['#ff0033', '#660000'], glow: '#ff0033', eyes: '#fff' }
        ];

        let currentSkin = SKINS[0];
        
        // --- ÉTAT DU JEU ---
        let gameState = 'MENU'; // MENU, PLAYING, PAUSED, GAMEOVER, COUNTDOWN
        let score = 0;
        let highScore = parseInt(localStorage.getItem('waajk_highscore')) || 0;
        
        let snake = [];
        let velocity = { x: 0, y: 0 };
        let nextVelocity = { x: 0, y: 0 };
        let food = { x: 5, y: 5 };
        
        // FX System
        let particles = [];
        let scoreFloats = [];
        let shakeIntensity = 0;
        let zoomLevel = 1.0;

        // Combo System
        let combo = 1;
        let lastEatTime = 0;
        const COMBO_TIMEOUT = 3000; // ms

        // Mobile Controls
        let touchStartX = 0;
        let touchStartY = 0;

        // --- RESIZE ---
        function resizeCanvas() {
            const margin = window.innerWidth < 768 ? 20 : 60;
            const uiHeight = 0; 

            const maxWidth = Math.min(window.innerWidth - margin, 800);
            const maxHeight = Math.min(window.innerHeight - margin - 40, 800);

            const cols = Math.floor(maxWidth / GRID_SIZE);
            const rows = Math.floor(maxHeight / GRID_SIZE);

            TILE_COUNT_X = cols;
            TILE_COUNT_Y = rows;

            canvas.width = TILE_COUNT_X * GRID_SIZE;
            canvas.height = TILE_COUNT_Y * GRID_SIZE;
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        updateUI();
        initSkinShop();

        // --- GAME LOOP ENGINE ---
        let lastTime = 0;
        let accumulator = 0;
        let step = 1 / BASE_SPEED;

        // Wrapper sécurisé pour lancer le jeu
        function safeStartGame() {
            SoundManager.safeInit();
            startGame();
        }

        function startGame() {
            if (gameState === 'PLAYING' || gameState === 'COUNTDOWN') return;

            snake = [
                { x: Math.floor(TILE_COUNT_X / 2), y: Math.floor(TILE_COUNT_Y / 2) },
                { x: Math.floor(TILE_COUNT_X / 2), y: Math.floor(TILE_COUNT_Y / 2) + 1 },
                { x: Math.floor(TILE_COUNT_X / 2), y: Math.floor(TILE_COUNT_Y / 2) + 2 }
            ];
            velocity = { x: 0, y: -1 };
            nextVelocity = { x: 0, y: -1 };
            score = 0;
            particles = [];
            scoreFloats = [];
            shakeIntensity = 0;
            combo = 1;
            zoomLevel = 1.0;
            gameSpeed = BASE_SPEED;
            step = 1 / gameSpeed;
            placeFood();
            
            // UI Reset
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('game-over').classList.add('hidden');
            document.getElementById('game-over').classList.remove('scale-100', 'opacity-100');
            document.getElementById('game-over').classList.add('scale-95', 'opacity-0');
            document.getElementById('skin-menu').classList.add('hidden');
            document.getElementById('hud').classList.remove('hidden');
            document.getElementById('pause-menu').classList.add('hidden');
            document.getElementById('ui-layer').classList.add('pointer-events-none');
            
            updateScoreDisplay();
            updateComboUI();

            startCountdown();
        }

        function startCountdown() {
            gameState = 'COUNTDOWN';
            let count = 3;
            const el = document.getElementById('countdown');
            const val = document.getElementById('countdown-val');
            el.classList.remove('hidden');
            
            val.innerText = count;
            SoundManager.play('click');

            const timer = setInterval(() => {
                count--;
                if (count > 0) {
                    val.innerText = count;
                    // Reset animation
                    val.style.animation = 'none';
                    val.offsetHeight; /* trigger reflow */
                    val.style.animation = 'zoomIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                    SoundManager.play('click');
                } else {
                    clearInterval(timer);
                    el.classList.add('hidden');
                    gameState = 'PLAYING';
                    
                    // Reset loop vars
                    lastTime = performance.now();
                    accumulator = 0;
                    
                    requestAnimationFrame(loop);
                }
            }, 800);
        }

        function loop(time) {
            if (gameState !== 'PLAYING') return;
            requestAnimationFrame(loop);

            if (!time) time = performance.now();
            let deltaTime = (time - lastTime) / 1000;
            lastTime = time;
            
            // Cap delta time to prevent spiraling after lag
            if (deltaTime > 0.1) deltaTime = 0.1;

            accumulator += deltaTime;
            
            // Fixed timestep update
            while (accumulator > step) {
                update();
                accumulator -= step;
            }

            draw();
        }

        // --- UPDATE LOGIC ---
        function update() {
            velocity = nextVelocity;

            const head = { x: snake[0].x + velocity.x, y: snake[0].y + velocity.y };

            // Wall Collision
            if (head.x < 0 || head.x >= TILE_COUNT_X || head.y < 0 || head.y >= TILE_COUNT_Y) {
                triggerGameOver();
                return;
            }

            // Self Collision
            for (let part of snake) {
                if (head.x === part.x && head.y === part.y) {
                    triggerGameOver();
                    return;
                }
            }

            snake.unshift(head);

            // Eat Food
            if (head.x === food.x && head.y === food.y) {
                handleEat(head.x, head.y);
            } else {
                snake.pop();
            }

            // Trail Particles (Chance to spawn on move)
            if (Math.random() > 0.6) {
                particles.push({
                    x: head.x * GRID_SIZE + GRID_SIZE/2,
                    y: head.y * GRID_SIZE + GRID_SIZE/2,
                    vx: (Math.random() - 0.5) * 0.5,
                    vy: (Math.random() - 0.5) * 0.5,
                    life: 0.6,
                    color: currentSkin.color,
                    size: Math.random() * 3,
                    type: 'trail'
                });
            }

            updateFX();
        }

        function handleEat(x, y) {
            const now = Date.now();
            if (now - lastEatTime < COMBO_TIMEOUT) {
                combo++;
            } else {
                combo = 1;
            }
            lastEatTime = now;
            
            // Score Logic & Progressive Speed
            const points = 10 * combo;
            score += points;
            
            // Augmenter la vitesse avec le score (Cap à 25)
            if (gameSpeed < 25) {
                gameSpeed = BASE_SPEED + (score / 400); 
                step = 1 / gameSpeed;
            }
            
            // FX
            shakeIntensity = 5 + (combo * 1.5);
            zoomLevel = 1.02; // Slight Pulse Zoom
            spawnEatParticles(x, y, currentSkin.glow);
            spawnFloatingText(x, y, `+${points}`);
            
            // Glitch effect on high combo
            if(combo > 3) {
                canvas.classList.add('glitch-effect');
                setTimeout(() => canvas.classList.remove('glitch-effect'), 200);
            }
            
            // Audio
            SoundManager.play(combo > 1 ? 'combo' : 'eat');

            updateScoreDisplay();
            updateComboUI();
            placeFood();
        }

        function placeFood() {
            let valid = false;
            while (!valid) {
                food.x = Math.floor(Math.random() * TILE_COUNT_X);
                food.y = Math.floor(Math.random() * TILE_COUNT_Y);
                valid = !snake.some(part => part.x === food.x && part.y === food.y);
            }
        }

        function spawnFloatingText(gx, gy, text) {
            const x = gx * GRID_SIZE + GRID_SIZE/2;
            const y = gy * GRID_SIZE;
            
            const el = document.createElement('div');
            el.className = 'score-float';
            el.style.left = canvas.offsetLeft + x + 'px';
            el.style.top = canvas.offsetTop + y + 'px';
            el.style.color = combo > 2 ? '#fbbf24' : '#fff'; 
            el.innerText = text;
            document.body.appendChild(el);
            
            setTimeout(() => el.remove(), 800);
        }

        // --- RENDERING ---
        function draw() {
            // Background & Camera Zoom
            ctx.save();
            
            // Apply Zoom
            if (zoomLevel > 1.0) {
                ctx.translate(canvas.width/2, canvas.height/2);
                ctx.scale(zoomLevel, zoomLevel);
                ctx.translate(-canvas.width/2, -canvas.height/2);
                zoomLevel = Math.max(1.0, zoomLevel - 0.005);
            }

            ctx.fillStyle = '#050508';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Combo Background Pulse
            if (combo > 2) {
                const alpha = Math.min((combo - 2) * 0.04, 0.15) + (Math.sin(Date.now() / 100) * 0.02);
                ctx.fillStyle = currentSkin.color;
                ctx.globalAlpha = alpha;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.globalAlpha = 1.0;
            }

            // Screen Shake
            if (shakeIntensity > 0) {
                const dx = (Math.random() - 0.5) * shakeIntensity;
                const dy = (Math.random() - 0.5) * shakeIntensity;
                ctx.translate(dx, dy);
            }

            // Moving Grid Background (Synthwave style)
            const time = Date.now() / 1000;
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.04)';
            ctx.lineWidth = 1;
            
            // Vertical lines
            for (let x = 0; x <= TILE_COUNT_X; x++) {
                ctx.beginPath();
                ctx.moveTo(x * GRID_SIZE, 0);
                ctx.lineTo(x * GRID_SIZE, canvas.height);
                ctx.stroke();
            }
            
            // Horizontal lines (scrolling)
            const scrollOffset = (time * 20) % GRID_SIZE;
            for (let y = -1; y <= TILE_COUNT_Y; y++) {
                ctx.beginPath();
                const yPos = (y * GRID_SIZE) + scrollOffset;
                ctx.moveTo(0, yPos);
                ctx.lineTo(canvas.width, yPos);
                ctx.stroke();
            }

            drawFood();
            drawSnake();
            drawParticles();

            ctx.restore();
        }

        function drawSnake() {
            snake.forEach((part, index) => {
                const x = part.x * GRID_SIZE;
                const y = part.y * GRID_SIZE;
                const size = GRID_SIZE - 2;
                
                // Skin Colors
                const gradient = ctx.createLinearGradient(x, y, x + size, y + size);
                gradient.addColorStop(0, currentSkin.gradient[0]);
                gradient.addColorStop(1, currentSkin.gradient[1]);

                ctx.fillStyle = gradient;
                
                // Head Glow
                if (index === 0) {
                    ctx.shadowBlur = 20 + (Math.sin(Date.now()/200)*8);
                    ctx.shadowColor = currentSkin.glow;
                } else {
                    ctx.shadowBlur = 0;
                }

                // Smooth Shape
                let drawSize = size;
                let offset = 1;
                // Shrink tail slightly
                if (index > snake.length - 3) {
                    drawSize *= 0.8;
                    offset += (size - drawSize) / 2;
                }

                roundRect(ctx, x + offset, y + offset, drawSize, drawSize, index === 0 ? 6 : 4);
                ctx.fill();

                // Eyes
                if (index === 0) {
                    ctx.shadowBlur = 0;
                    ctx.fillStyle = currentSkin.eyes;
                    const eyeSize = drawSize * 0.25;
                    const cx = x + offset + drawSize/2;
                    const cy = y + offset + drawSize/2;
                    const shift = drawSize * 0.25;
                    
                    let ex1, ey1, ex2, ey2;
                    
                    if (velocity.x !== 0) { 
                         ex1 = velocity.x > 0 ? cx + shift/2 : cx - shift/2;
                         ex2 = ex1;
                         if(velocity.x > 0) { ex1 = cx + shift/2; ex2 = cx + shift/2; ey1 = cy - shift; ey2 = cy + shift; }
                         if(velocity.x < 0) { ex1 = cx - shift/2; ex2 = cx - shift/2; ey1 = cy - shift; ey2 = cy + shift; }
                    } else {
                         if(velocity.y > 0) { ey1 = cy + shift/2; ey2 = cy + shift/2; ex1 = cx - shift; ex2 = cx + shift; }
                         if(velocity.y < 0) { ey1 = cy - shift/2; ey2 = cy - shift/2; ex1 = cx - shift; ex2 = cx + shift; }
                    }
                    
                    ctx.beginPath(); ctx.arc(ex1, ey1, eyeSize/2, 0, Math.PI*2); ctx.fill();
                    ctx.beginPath(); ctx.arc(ex2, ey2, eyeSize/2, 0, Math.PI*2); ctx.fill();
                }
            });
            ctx.shadowBlur = 0;
        }

        function drawFood() {
            const cx = food.x * GRID_SIZE + GRID_SIZE/2;
            const cy = food.y * GRID_SIZE + GRID_SIZE/2;
            const pulse = Math.sin(Date.now() / 150) * 2;
            
            ctx.shadowBlur = 15;
            ctx.shadowColor = currentSkin.glow;
            
            // Core
            ctx.fillStyle = '#fff';
            ctx.beginPath(); ctx.arc(cx, cy, (GRID_SIZE/3) + pulse/2, 0, Math.PI*2); ctx.fill();

            // Outer ring with rotation
            ctx.strokeStyle = currentSkin.color;
            ctx.lineWidth = 2;
            
            // Rotating ring effect
            const angle = Date.now() / 500;
            ctx.beginPath(); 
            ctx.arc(cx, cy, (GRID_SIZE/2) - 1 + pulse, angle, angle + Math.PI*1.5); 
            ctx.stroke();
            
            ctx.shadowBlur = 0;
        }

        // --- FX SYSTEM ---
        function spawnEatParticles(gx, gy, color) {
            const cx = gx * GRID_SIZE + GRID_SIZE/2;
            const cy = gy * GRID_SIZE + GRID_SIZE/2;
            for(let i=0; i<15; i++) {
                particles.push({
                    x: cx,
                    y: cy,
                    vx: (Math.random() - 0.5) * 12,
                    vy: (Math.random() - 0.5) * 12,
                    life: 1.0,
                    color: color,
                    size: Math.random() * 4 + 1,
                    type: 'explode'
                });
            }
        }

        function updateFX() {
            // Particles
            for(let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.life -= 0.03;
                p.size *= 0.94;
                
                // Gravity for explosions
                if(p.type === 'explode') {
                    p.vx *= 0.92;
                    p.vy *= 0.92;
                }
                
                if(p.life <= 0) particles.splice(i, 1);
            }

            // Shake dampening
            if (shakeIntensity > 0) shakeIntensity *= 0.9;
            if (shakeIntensity < 0.5) shakeIntensity = 0;
        }

        function drawParticles() {
            particles.forEach(p => {
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
                ctx.fill();
            });
            ctx.globalAlpha = 1.0;
        }

        // --- UI & HELPERS ---
        function triggerGameOver() {
            gameState = 'GAMEOVER';
            shakeIntensity = 30;
            SoundManager.play('die');

            if (score > highScore) {
                highScore = score;
                localStorage.setItem('waajk_highscore', highScore);
            }

            updateUI();
            
            document.getElementById('hud').classList.add('hidden');
            document.getElementById('ui-layer').classList.remove('pointer-events-none');
            
            const goPanel = document.getElementById('game-over');
            goPanel.classList.remove('hidden');
            setTimeout(() => {
                goPanel.classList.remove('scale-95', 'opacity-0');
                goPanel.classList.add('scale-100', 'opacity-100');
            }, 50);

            document.getElementById('final-score').innerText = score;
        }

        function togglePause() {
            if (gameState === 'PLAYING') {
                gameState = 'PAUSED';
                document.getElementById('pause-menu').classList.remove('hidden');
                document.getElementById('ui-layer').classList.remove('pointer-events-none');
            } else if (gameState === 'PAUSED') {
                resumeGame();
            }
        }

        function resumeGame() {
            document.getElementById('pause-menu').classList.add('hidden');
            document.getElementById('ui-layer').classList.add('pointer-events-none');
            startCountdown();
        }

        function quitToMenu() {
            showMainMenu();
        }

        function showMainMenu() {
            gameState = 'MENU';
            document.getElementById('skin-menu').classList.add('hidden');
            document.getElementById('game-over').classList.add('hidden');
            document.getElementById('pause-menu').classList.add('hidden');
            document.getElementById('main-menu').classList.remove('hidden');
            document.getElementById('ui-layer').classList.remove('pointer-events-none');
            // Clean canvas background
            ctx.fillStyle = '#050508';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            updateUI();
        }

        function showSkins() {
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('skin-menu').classList.remove('hidden');
        }

        function updateUI() {
            document.getElementById('menu-highscore').innerText = highScore;
            document.getElementById('go-highscore').innerText = highScore;
            document.getElementById('current-skin-name').innerText = currentSkin.name;
            document.getElementById('menu-skin-dot').style.backgroundColor = currentSkin.color;
            document.getElementById('menu-skin-dot').style.boxShadow = `0 0 10px ${currentSkin.glow}`;
        }

        function updateScoreDisplay() {
            const scoreEl = document.getElementById('game-score');
            scoreEl.innerText = score;
        }

        function updateComboUI() {
            const container = document.getElementById('combo-container');
            const text = document.getElementById('combo-text');
            
            if (combo > 1) {
                container.classList.remove('opacity-0');
                text.innerText = 'x' + combo;
                text.style.color = combo > 4 ? '#ef4444' : (combo > 2 ? '#eab308' : '#fff');
                
                // Pop animation
                text.classList.remove('combo-pop');
                void text.offsetWidth; // Reflow
                text.classList.add('combo-pop');
            } else {
                container.classList.add('opacity-0');
            }
        }

        function initSkinShop() {
            const grid = document.getElementById('skin-grid');
            grid.innerHTML = '';
            SKINS.forEach(skin => {
                const card = document.createElement('div');
                card.className = `skin-card ${skin.id === currentSkin.id ? 'active' : ''}`;
                card.onclick = () => {
                    SoundManager.play('click');
                    currentSkin = skin;
                    initSkinShop();
                };

                const preview = document.createElement('div');
                preview.className = 'skin-preview';
                preview.style.background = `linear-gradient(135deg, ${skin.gradient[0]}, ${skin.gradient[1]})`;
                preview.style.color = skin.glow;

                const name = document.createElement('span');
                name.className = 'text-[9px] font-bold text-gray-400 uppercase tracking-wide text-center leading-tight';
                name.innerText = skin.name;

                if (skin.id === currentSkin.id) {
                    const check = document.createElement('div');
                    check.innerHTML = '<i class="fas fa-check-circle text-green-400 absolute top-2 right-2 text-[10px]"></i>';
                    card.appendChild(check);
                }

                card.appendChild(preview);
                card.appendChild(name);
                grid.appendChild(card);
            });
        }

        function roundRect(ctx, x, y, width, height, radius) {
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
            ctx.lineTo(x + width, y + height - radius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            ctx.lineTo(x + radius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath();
        }

        // --- CONTROLS ---
        window.addEventListener('keydown', e => {
            if (gameState === 'MENU' && e.key === 'Enter') safeStartGame();
            if (e.key === 'Escape') togglePause();
            if (gameState !== 'PLAYING') return;
            
            // Allow WASD
            const key = e.key.toLowerCase();
            
            if ((e.key === 'ArrowUp' || key === 'w') && velocity.y !== 1) nextVelocity = {x: 0, y: -1};
            if ((e.key === 'ArrowDown' || key === 's') && velocity.y !== -1) nextVelocity = {x: 0, y: 1};
            if ((e.key === 'ArrowLeft' || key === 'a') && velocity.x !== 1) nextVelocity = {x: -1, y: 0};
            if ((e.key === 'ArrowRight' || key === 'd') && velocity.x !== -1) nextVelocity = {x: 1, y: 0};
        });

        // Swipe Controls
        canvas.addEventListener('touchstart', e => {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            e.preventDefault(); // Stop scroll
        }, {passive: false});

        canvas.addEventListener('touchmove', e => {
            e.preventDefault(); // Stop scroll
        }, {passive: false});

        canvas.addEventListener('touchend', e => {
            if (gameState !== 'PLAYING') return;
            
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;
            
            const dx = touchEndX - touchStartX;
            const dy = touchEndY - touchStartY;
            
            if (Math.abs(dx) > Math.abs(dy)) {
                // Horizontal
                if (Math.abs(dx) > 30) { // Threshold
                    if (dx > 0 && velocity.x !== -1) nextVelocity = {x: 1, y: 0};
                    else if (dx < 0 && velocity.x !== 1) nextVelocity = {x: -1, y: 0};
                }
            } else {
                // Vertical
                if (Math.abs(dy) > 30) {
                    if (dy > 0 && velocity.y !== -1) nextVelocity = {x: 0, y: 1};
                    else if (dy < 0 && velocity.y !== 1) nextVelocity = {x: 0, y: -1};
                }
            }
        });
    </script>
</body>
</html>
