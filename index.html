<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Galactic Defender Ultimate</title>
    <!-- Importation de FontAwesome pour les icônes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #00d2ff;
            --secondary: #3a7bd5;
            --accent: #ffea00;
            --danger: #ff4444;
            --bg: #050505;
            --glass: rgba(20, 20, 30, 0.85);
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: var(--bg);
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            touch-action: none;
            user-select: none;
        }

        canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        /* --- UI LAYER --- */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none; /* Laisse passer les clics vers le canvas si besoin */
        }

        /* Classes utilitaires */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            pointer-events: auto;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            transition: opacity 0.3s;
            overflow-y: auto; /* Pour le scroll sur mobile */
        }

        .hidden {
            opacity: 0;
            pointer-events: none !important;
            z-index: -1;
        }

        /* --- HEADER & CURRENCY --- */
        .currency-bar {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 15px;
            font-size: 18px;
            font-weight: bold;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px 20px;
            border-radius: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .coin-display { color: var(--accent); }
        .level-display { color: var(--primary); }

        /* --- LOBBY --- */
        #lobby-screen {
            justify-content: center;
        }

        h1 {
            font-size: 50px;
            margin: 0 0 10px 0;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-transform: uppercase;
            letter-spacing: 4px;
            text-shadow: 0 0 20px rgba(0, 210, 255, 0.3);
            text-align: center;
        }

        .xp-container {
            width: 300px;
            margin-bottom: 40px;
            text-align: center;
        }

        .xp-bar-bg {
            width: 100%;
            height: 10px;
            background: #333;
            border-radius: 5px;
            margin-top: 5px;
            overflow: hidden;
        }

        .xp-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), #00ff88);
            width: 0%;
            transition: width 0.5s ease-out;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        /* --- BUTTONS --- */
        .btn {
            padding: 15px 30px;
            font-size: 18px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            color: white;
            font-weight: bold;
            text-transform: uppercase;
            transition: transform 0.1s, box-shadow 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-width: 160px;
        }

        .btn:active { transform: scale(0.95); }
        
        .btn-primary {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            box-shadow: 0 4px 15px rgba(0, 210, 255, 0.3);
            width: 250px;
            height: 60px;
            font-size: 24px;
            grid-column: span 2; /* Bouton jouer prend toute la largeur */
        }

        .btn-secondary {
            background: var(--glass);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-shop { color: var(--accent); }
        .btn-pass { color: #ff8800; }

        /* --- SHOP & PASS --- */
        .content-container {
            width: 90%;
            max-width: 800px;
            margin-top: 80px;
            padding-bottom: 50px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
        }

        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
        }

        /* Shop Cards */
        .shop-card {
            background: var(--glass);
            border-radius: 15px;
            padding: 20px;
            width: 140px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: border-color 0.2s;
            position: relative;
        }

        .shop-card.owned { border-color: #00ff88; }
        .shop-card.selected { border-color: var(--primary); box-shadow: 0 0 15px var(--primary); }

        .skin-preview {
            width: 50px;
            height: 50px;
            margin: 0 auto 10px auto;
            border-radius: 50%;
        }

        .price-tag { color: var(--accent); font-weight: bold; margin-top: 5px; }
        
        /* Battle Pass Rows */
        .pass-row {
            background: var(--glass);
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-left: 5px solid #333;
        }

        .pass-row.unlocked { border-left-color: #00ff88; }
        .pass-row.locked { opacity: 0.6; }

        .reward-info { display: flex; align-items: center; gap: 15px; }
        .reward-icon { font-size: 24px; color: var(--accent); }

        .claim-btn {
            background: #00ff88;
            color: black;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .claim-btn:disabled { background: #555; color: #888; cursor: default; }

        /* --- HUD (IN GAME) --- */
        #hud {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            justify-content: space-between;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 0 0 5px black;
        }

        /* --- GAME OVER --- */
        #game-over-stats {
            background: var(--glass);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: left;
            min-width: 200px;
        }
        .stat-line { display: flex; justify-content: space-between; margin: 5px 0; }
        .gain { color: #00ff88; }

    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        
        <!-- GLOBAL CURRENCY (Visible in menus) -->
        <div id="global-currency" class="currency-bar">
            <span class="level-display"><i class="fas fa-star"></i> Lvl <span id="ui-level">1</span></span>
            <span class="coin-display"><i class="fas fa-coins"></i> <span id="ui-coins">0</span></span>
        </div>

        <!-- LOBBY SCREEN -->
        <div id="lobby-screen" class="screen">
            <h1>Galactic<br>Defender</h1>
            
            <div class="xp-container">
                <div>Niveau <span id="lobby-level">1</span></div>
                <div class="xp-bar-bg">
                    <div id="lobby-xp-fill" class="xp-bar-fill"></div>
                </div>
                <div style="font-size: 12px; margin-top: 5px; color: #888;"><span id="lobby-xp-text">0 / 100</span> XP</div>
            </div>

            <div class="menu-grid">
                <button class="btn btn-primary" onclick="startGame()">
                    <i class="fas fa-play"></i> JOUER
                </button>
                <button class="btn btn-secondary btn-shop" onclick="openShop()">
                    <i class="fas fa-shopping-cart"></i> Shop
                </button>
                <button class="btn btn-secondary btn-pass" onclick="openPass()">
                    <i class="fas fa-list-alt"></i> Pass
                </button>
            </div>
            
            <div style="font-size: 12px; color: #555;">v2.0 Ultimate Edition</div>
        </div>

        <!-- SHOP SCREEN -->
        <div id="shop-screen" class="screen hidden">
            <div class="back-btn" onclick="openLobby()"><i class="fas fa-arrow-left"></i> Retour</div>
            <h2>Hangar Spatial</h2>
            <div id="shop-container" class="content-container">
                <!-- Shop items injected by JS -->
            </div>
        </div>

        <!-- BATTLE PASS SCREEN -->
        <div id="pass-screen" class="screen hidden">
            <div class="back-btn" onclick="openLobby()"><i class="fas fa-arrow-left"></i> Retour</div>
            <h2>Pass de Combat</h2>
            <div id="pass-container" class="content-container">
                <!-- Pass items injected by JS -->
            </div>
        </div>

        <!-- IN GAME HUD -->
        <div id="hud" class="hidden">
            <div id="game-score">Score: 0</div>
            <!-- On pourrait ajouter une barre de vie ici -->
        </div>

        <!-- GAME OVER SCREEN -->
        <div id="game-over-screen" class="screen hidden">
            <h1>Terminé</h1>
            <div id="game-over-stats">
                <div class="stat-line">Score: <span id="end-score">0</span></div>
                <div class="stat-line">Pièces: <span id="end-coins" class="gain">+0</span></div>
                <div class="stat-line">XP: <span id="end-xp" class="gain">+0</span></div>
            </div>
            <button class="btn btn-primary" onclick="openLobby()">
                <i class="fas fa-home"></i> Lobby
            </button>
        </div>

    </div>

    <script>
        /**
         * DONNÉES ET ÉTAT DU JOUEUR (PERSISTANT)
         */
        const playerData = {
            coins: 0,
            level: 1,
            xp: 0,
            xpToNext: 100,
            inventory: ['default'], // Skins possédés
            equippedSkin: 'default',
            claimedPassRewards: [] // IDs des récompenses réclamées
        };

        const SKINS_DB = {
            'default': { name: 'Intercepteur', color: '#00d2ff', price: 0, type: 'standard' },
            'red': { name: 'Fureur Rouge', color: '#ff4444', price: 100, type: 'attack' },
            'gold': { name: 'Luxe Doré', color: '#ffea00', price: 500, type: 'gold' },
            'stealth': { name: 'Fantôme', color: '#00ff88', price: 250, type: 'speed' },
            'purple': { name: 'Néon', color: '#d200ff', price: 150, type: 'standard' }
        };

        const BATTLE_PASS_DB = [
            { level: 2, type: 'coins', amount: 50, desc: '50 Pièces' },
            { level: 3, type: 'coins', amount: 100, desc: '100 Pièces' },
            { level: 5, type: 'skin', id: 'purple', desc: 'Skin Néon' },
            { level: 7, type: 'coins', amount: 500, desc: '500 Pièces' },
            { level: 10, type: 'skin', id: 'gold', desc: 'Skin Luxe' }
        ];

        // --- MOTEUR DU JEU ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let width, height;
        
        let gameRunning = false;
        let animationId;
        let score = 0;
        let frames = 0;
        let input = { x: 0, y: 0, shooting: false, left: false, right: false, type: 'mouse' };
        
        // Entités
        let player, projectiles = [], enemies = [], particles = [], stars = [];

        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
            if(!gameRunning && player) {
                player.position.x = width/2;
                player.position.y = height - 100;
            }
        }
        window.addEventListener('resize', resize);

        // --- CLASSES ---
        class Player {
            constructor() {
                this.position = { x: width / 2, y: height - 100 };
                this.velocity = { x: 0, y: 0 };
                this.width = 30;
                this.height = 40;
                this.speed = 7;
                
                // Appliquer les stats du skin
                const skin = SKINS_DB[playerData.equippedSkin];
                this.color = skin.color;
            }

            draw() {
                ctx.save();
                ctx.translate(this.position.x, this.position.y);
                ctx.rotate(this.velocity.x * 0.05);

                // Design du vaisseau (simplifié mais coloré)
                ctx.beginPath();
                ctx.moveTo(0, -this.height);
                ctx.lineTo(-this.width, this.height);
                ctx.lineTo(0, this.height - 15);
                ctx.lineTo(this.width, this.height);
                ctx.closePath();
                
                ctx.fillStyle = this.color;
                ctx.shadowBlur = 20;
                ctx.shadowColor = this.color;
                ctx.fill();

                // Détails
                ctx.fillStyle = 'rgba(255,255,255,0.8)';
                ctx.beginPath();
                ctx.moveTo(0, -10);
                ctx.lineTo(-5, 20);
                ctx.lineTo(5, 20);
                ctx.fill();

                // Flamme
                if (gameRunning) {
                    ctx.beginPath();
                    ctx.moveTo(-8, this.height);
                    ctx.lineTo(0, this.height + 25 + Math.random() * 15);
                    ctx.lineTo(8, this.height);
                    ctx.fillStyle = '#ffaa00';
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = 'orange';
                    ctx.fill();
                }

                ctx.restore();
            }

            update() {
                if (input.type === 'keyboard') {
                    if (input.right) this.velocity.x = this.speed;
                    else if (input.left) this.velocity.x = -this.speed;
                    else this.velocity.x = 0;
                } else {
                    const dx = input.x - this.position.x;
                    this.velocity.x = dx * 0.15;
                }

                this.position.x += this.velocity.x;
                // Clamp position
                if(this.position.x < this.width) this.position.x = this.width;
                if(this.position.x > width - this.width) this.position.x = width - this.width;
            }
        }

        class Projectile {
            constructor({ x, y }) {
                this.position = { x, y };
                this.velocity = { x: 0, y: -15 };
                this.radius = 4;
            }
            draw() {
                ctx.beginPath();
                ctx.arc(this.position.x, this.position.y, this.radius, 0, Math.PI*2);
                ctx.fillStyle = '#fff';
                ctx.shadowBlur = 10;
                ctx.shadowColor = '#fff';
                ctx.fill();
            }
            update() {
                this.position.y += this.velocity.y;
            }
        }

        class Enemy {
            constructor() {
                this.radius = Math.random() * 20 + 15;
                this.position = { x: Math.random() * (width - 60) + 30, y: -50 };
                this.velocity = { x: (Math.random()-0.5), y: (Math.random() * 3 + 2) + (score * 0.005) };
                this.color = `hsl(${Math.random()*360}, 50%, 50%)`;
                this.points = [];
                const sides = Math.floor(Math.random() * 3) + 5;
                for(let i=0; i<sides; i++) {
                    const angle = (i/sides) * Math.PI * 2;
                    this.points.push({x: Math.cos(angle)*this.radius, y: Math.sin(angle)*this.radius});
                }
                this.rotation = 0;
            }
            draw() {
                ctx.save();
                ctx.translate(this.position.x, this.position.y);
                ctx.rotate(this.rotation);
                ctx.beginPath();
                ctx.moveTo(this.points[0].x, this.points[0].y);
                for(let i=1; i<this.points.length; i++) ctx.lineTo(this.points[i].x, this.points[i].y);
                ctx.closePath();
                ctx.strokeStyle = this.color;
                ctx.lineWidth = 3;
                ctx.stroke();
                ctx.restore();
            }
            update() {
                this.position.x += this.velocity.x;
                this.position.y += this.velocity.y;
                this.rotation += 0.05;
                if(this.position.x < 0 || this.position.x > width) this.velocity.x *= -1;
            }
        }

        class Particle {
            constructor({x, y, color}) {
                this.position = {x, y};
                this.velocity = {x: (Math.random()-0.5)*5, y: (Math.random()-0.5)*5};
                this.alpha = 1;
                this.color = color;
            }
            draw() {
                ctx.save();
                ctx.globalAlpha = this.alpha;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.position.x, this.position.y, 3, 0, Math.PI*2);
                ctx.fill();
                ctx.restore();
            }
            update() {
                this.position.x += this.velocity.x;
                this.position.y += this.velocity.y;
                this.alpha -= 0.03;
            }
        }

        class Star {
            constructor() {
                this.position = { x: Math.random()*width, y: Math.random()*height };
                this.speed = Math.random() * 2 + 0.5;
                this.size = Math.random() * 2;
            }
            draw() {
                ctx.fillStyle = `rgba(255,255,255,${Math.random()})`;
                ctx.fillRect(this.position.x, this.position.y, this.size, this.size);
            }
            update() {
                this.position.y += this.speed;
                if(this.position.y > height) {
                    this.position.y = 0;
                    this.position.x = Math.random()*width;
                }
            }
        }

        // --- GESTION DU JEU ---
        function initGame() {
            resize();
            player = new Player();
            projectiles = [];
            enemies = [];
            particles = [];
            score = 0;
            frames = 0;
            document.getElementById('game-score').innerText = 'Score: 0';
        }

        function createStars() {
            stars = [];
            for(let i=0; i<100; i++) stars.push(new Star());
        }

        function animate() {
            if (!gameRunning) {
                // Background animation in menu
                ctx.fillStyle = 'rgba(5, 5, 5, 0.3)';
                ctx.fillRect(0, 0, width, height);
                stars.forEach(s => { s.update(); s.draw(); });
                requestAnimationFrame(animate);
                return;
            }

            animationId = requestAnimationFrame(animate);
            ctx.fillStyle = 'rgba(5, 5, 5, 0.3)';
            ctx.fillRect(0, 0, width, height);

            stars.forEach(s => { s.update(); s.draw(); });

            player.update();
            player.draw();

            // Projectiles
            projectiles.forEach((p, i) => {
                p.update();
                p.draw();
                if (p.position.y < 0) setTimeout(() => projectiles.splice(i, 1), 0);
            });

            // Enemies
            if (frames % 60 === 0) enemies.push(new Enemy());
            
            enemies.forEach((e, i) => {
                e.update();
                e.draw();
                
                // Collision Joueur
                const distPlayer = Math.hypot(player.position.x - e.position.x, player.position.y - e.position.y);
                if (distPlayer - e.radius - player.width < -10) {
                    gameOver();
                }

                // Cleanup
                if (e.position.y > height) setTimeout(() => enemies.splice(i, 1), 0);

                // Collision Tir
                projectiles.forEach((p, pi) => {
                    const dist = Math.hypot(p.position.x - e.position.x, p.position.y - e.position.y);
                    if (dist - e.radius < 5) {
                        for(let k=0; k<8; k++) particles.push(new Particle({x: e.position.x, y: e.position.y, color: e.color}));
                        score += 10;
                        document.getElementById('game-score').innerText = 'Score: ' + score;
                        setTimeout(() => {
                            enemies.splice(i, 1);
                            projectiles.splice(pi, 1);
                        }, 0);
                    }
                });
            });

            // Particles
            particles.forEach((p, i) => {
                if (p.alpha <= 0) particles.splice(i, 1);
                else { p.update(); p.draw(); }
            });

            // Tir Auto
            if(input.shooting && frames % 12 === 0) {
                projectiles.push(new Projectile({x: player.position.x, y: player.position.y - 40}));
            }

            frames++;
        }

        // --- SYSTÈME DE PROGRESSION ---

        function updateCurrencyUI() {
            document.getElementById('ui-coins').innerText = playerData.coins;
            document.getElementById('ui-level').innerText = playerData.level;
            
            document.getElementById('lobby-level').innerText = playerData.level;
            document.getElementById('lobby-xp-text').innerText = `${Math.floor(playerData.xp)} / ${playerData.xpToNext}`;
            const pct = (playerData.xp / playerData.xpToNext) * 100;
            document.getElementById('lobby-xp-fill').style.width = `${pct}%`;
        }

        function gainXP(amount) {
            playerData.xp += amount;
            if (playerData.xp >= playerData.xpToNext) {
                playerData.xp -= playerData.xpToNext;
                playerData.level++;
                playerData.xpToNext = Math.floor(playerData.xpToNext * 1.2);
                alert(`NIVEAU SUPÉRIEUR ! Vous êtes niveau ${playerData.level} !`);
            }
            updateCurrencyUI();
        }

        // --- GESTION UI & ÉCRANS ---

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById('global-currency').style.display = 'flex'; // Reset default
            
            const el = document.getElementById(id);
            if(el) el.classList.remove('hidden');

            if (id === 'hud') {
                document.getElementById('global-currency').style.display = 'none';
            }
        }

        function startGame() {
            initGame();
            gameRunning = true;
            showScreen('hud');
        }

        function gameOver() {
            gameRunning = false;
            
            // Calcul récompenses
            const coinsEarned = Math.floor(score / 2);
            const xpEarned = Math.floor(score / 1.5);

            playerData.coins += coinsEarned;
            gainXP(xpEarned);

            document.getElementById('end-score').innerText = score;
            document.getElementById('end-coins').innerText = `+${coinsEarned}`;
            document.getElementById('end-xp').innerText = `+${xpEarned}`;

            showScreen('game-over-screen');
        }

        function openLobby() {
            gameRunning = false; // Stop game loop logic
            updateCurrencyUI();
            showScreen('lobby-screen');
        }

        // --- SHOP LOGIC ---
        function openShop() {
            const container = document.getElementById('shop-container');
            container.innerHTML = '';

            Object.keys(SKINS_DB).forEach(key => {
                const skin = SKINS_DB[key];
                const isOwned = playerData.inventory.includes(key);
                const isEquipped = playerData.equippedSkin === key;

                const card = document.createElement('div');
                card.className = `shop-card ${isOwned ? 'owned' : ''} ${isEquipped ? 'selected' : ''}`;
                
                card.innerHTML = `
                    <div class="skin-preview" style="background-color: ${skin.color}; box-shadow: 0 0 10px ${skin.color}"></div>
                    <div style="font-weight:bold;">${skin.name}</div>
                    <div class="price-tag">${isOwned ? (isEquipped ? 'ÉQUIPÉ' : 'POSSÉDÉ') : skin.price + ' <i class="fas fa-coins"></i>'}</div>
                `;

                card.onclick = () => {
                    if (isOwned) {
                        playerData.equippedSkin = key;
                        openShop(); // Refresh UI
                    } else {
                        if (playerData.coins >= skin.price) {
                            if(confirm(`Acheter ${skin.name} pour ${skin.price} pièces ?`)) {
                                playerData.coins -= skin.price;
                                playerData.inventory.push(key);
                                playerData.equippedSkin = key;
                                updateCurrencyUI();
                                openShop();
                            }
                        } else {
                            alert("Pas assez de pièces !");
                        }
                    }
                };
                container.appendChild(card);
            });
            showScreen('shop-screen');
        }

        // --- BATTLE PASS LOGIC ---
        function openPass() {
            const container = document.getElementById('pass-container');
            container.innerHTML = '';

            BATTLE_PASS_DB.forEach((reward, index) => {
                const isUnlocked = playerData.level >= reward.level;
                const isClaimed = playerData.claimedPassRewards.includes(index);

                const row = document.createElement('div');
                row.className = `pass-row ${isUnlocked ? 'unlocked' : 'locked'}`;
                
                let icon = reward.type === 'coins' ? 'fa-coins' : 'fa-rocket';
                
                row.innerHTML = `
                    <div class="reward-info">
                        <div style="font-weight:bold; color: #888;">Niv. ${reward.level}</div>
                        <i class="fas ${icon} reward-icon"></i>
                        <div>${reward.desc}</div>
                    </div>
                    <button class="claim-btn" ${(!isUnlocked || isClaimed) ? 'disabled' : ''} 
                        onclick="claimReward(${index})">
                        ${isClaimed ? 'Reçu' : (isUnlocked ? 'Réclamer' : 'Bloqué')}
                    </button>
                `;
                container.appendChild(row);
            });
            showScreen('pass-screen');
        }

        window.claimReward = function(index) {
            const reward = BATTLE_PASS_DB[index];
            playerData.claimedPassRewards.push(index);
            
            if (reward.type === 'coins') {
                playerData.coins += reward.amount;
                alert(`Vous avez reçu ${reward.amount} pièces !`);
            } else if (reward.type === 'skin') {
                if (!playerData.inventory.includes(reward.id)) {
                    playerData.inventory.push(reward.id);
                    alert(`Nouveau skin débloqué : ${SKINS_DB[reward.id].name} !`);
                } else {
                    playerData.coins += 100; // Compensation si déjà possédé
                    alert("Skin déjà possédé. +100 pièces en compensation.");
                }
            }
            updateCurrencyUI();
            openPass();
        }

        // --- INPUTS ---
        window.addEventListener('keydown', e => {
            if(e.key === 'ArrowRight') input.right = true;
            if(e.key === 'ArrowLeft') input.left = true;
            if(e.key === ' ') input.shooting = true;
            input.type = 'keyboard';
        });
        window.addEventListener('keyup', e => {
            if(e.key === 'ArrowRight') input.right = false;
            if(e.key === 'ArrowLeft') input.left = false;
            if(e.key === ' ') input.shooting = false;
        });
        window.addEventListener('mousemove', e => {
            input.x = e.clientX;
            input.y = e.clientY;
            input.type = 'mouse';
        });
        window.addEventListener('mousedown', () => input.shooting = true);
        window.addEventListener('mouseup', () => input.shooting = false);
        
        // Touch
        window.addEventListener('touchmove', e => {
            e.preventDefault();
            input.x = e.touches[0].clientX;
            input.y = e.touches[0].clientY;
            input.type = 'mouse';
        }, {passive: false});
        window.addEventListener('touchstart', e => {
             input.shooting = true;
             input.x = e.touches[0].clientX;
        });
        window.addEventListener('touchend', () => input.shooting = false);


        // --- INIT ---
        createStars();
        animate(); // Start background animation
        openLobby(); // Start in lobby

    </script>
</body>
</html>
